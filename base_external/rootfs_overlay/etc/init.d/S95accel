#!/bin/sh
#
# S95accel   Start/stop the accel char‐driver + demo_app
#

MODULE_NAME="char_driver"
KO_PATH="/lib/modules/$(uname -r)/kernel/drivers/accel/char_driver.ko"
APP_PATH="/usr/bin/demo_app"
PID_FILE="/var/run/demo_app.pid"

case "$1" in
  start)
    echo "[$(date)] Loading kernel module: ${MODULE_NAME}"
    if ! /sbin/lsmod | grep -q "^${MODULE_NAME}"; then
      # try modprobe first (requires depmod run at build time)
      if ! /sbin/modprobe ${MODULE_NAME}; then
        echo "modprobe failed, trying insmod ${KO_PATH}"
        /sbin/insmod "${KO_PATH}" || {
          echo "ERROR: Failed to load ${KO_PATH}"
          exit 1
        }
      fi
    else
      echo "Module ${MODULE_NAME} already loaded"
    fi

    echo "[$(date)] Starting demo_app"
    nohup "${APP_PATH}" >/dev/null 2>&1 &
    echo $! > "${PID_FILE}"
    echo "demo_app PID=$(cat "${PID_FILE}")"
    ;;

  stop)
    echo "[$(date)] Stopping demo_app"
    if [ -f "${PID_FILE}" ]; then
      kill "$(cat "${PID_FILE}")" 2>/dev/null || true
      rm -f "${PID_FILE}"
    else
      echo "demo_app not running"
    fi

    echo "[$(date)] Unloading module: ${MODULE_NAME}"
    /sbin/rmmod "${MODULE_NAME}" 2>/dev/null || \
      echo "Module ${MODULE_NAME} not loaded"
    ;;

  restart)
    $0 stop
    sleep 1
    $0 start
    ;;

  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 2
    ;;
esac

exit 0

